.title hasophash - calculate op hash of HAS060X.X

;This file is part of Xperiment68k
;Copyright (C) 2025 TcbnErik
;
;This program is free software: you can redistribute it and/or modify
;it under the terms of the GNU General Public License as published by
;the Free Software Foundation, either version 3 of the License, or
;(at your option) any later version.
;
;This program is distributed in the hope that it will be useful,
;but WITHOUT ANY WARRANTY; without even the implied warranty of
;MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;GNU General Public License for more details.
;
;You should have received a copy of the GNU General Public License
;along with this program.  If not, see <https://www.gnu.org/licenses/>.

.include macro.mac

.include xputil.mac

CMDHASHSIZE: .equ 1024


.cpu 68000
.text

ProgramStart:
  lea (Buffer,pc),a0
  lea (1,a2),a1
  SKIP_SPACE a1
  beq 1f
    ;コマンドライン引数で指定した文字列のハッシュ値を計算して表示する
    bsr StringifyOp
    bra @f
  1:
    ;全命令のハッシュ値を計算して表示する
    bsr StringifyAllOp
  @@:

  lea (Buffer,pc),a1  ;DOS _PRINTよりDOS _WRITEの方が速い
  sub.l a1,a0  ;文字列長
  move.l a0,-(sp)
  pea (a1)
  move #STDOUT,-(sp)
  DOS _WRITE
  lea (10,sp),sp

  DOS _EXIT


StringifyOp:
  STRLEN a1,d0
  subq #1,d0  ;キー文字列長-1
  bsr CalculateHash

  bsr ToHexString$4
  lea (strCrLf,pc),a1
  STRCPY a1,a0,-1
  rts


StringifyAllOp:
  lea (OpTable,pc),a3
  bra 8f
  1:
    lea (a3),a1
    bsr CalculateHash
    bsr ToHexString$4
    move.b #' ',(a0)+

    STRCPY a3,a0,-1  ;キー文字列
    lea (strCrLf,pc),a1
    STRCPY a1,a0,-1
  8:
  STRLEN a3,d0
  subq #1,d0  ;キー文字列長-1
  bcc 1b
  rts


CalculateHash:
  move d0,d2  ;キー文字列長-1
  moveq #0,d0
  @@:
    moveq #$20,d1
    or.b (a1)+,d1  ;小文字化
    add d1,d0
    ror #3,d0
    sub d1,d0
  dbra d2,@b
  andi.l #CMDHASHSIZE-1,d0
  rts


  DEFINE_TOHEXSTRING$4 ToHexString$4


.data

strCrLf: .dc.b CR,LF,0

len:=0  ;文字列化に必要なバッファサイズ
op: .macro str
  .dc.b str,0
  len:=len+.sizeof.('$0123 ')+.sizeof.(str)+2  ;+2はCRLF
.endm

OpTable:
  op 'move'
  op 'moveq'
  op 'movea'
  op 'movem'
  op 'lea'
  op 'pea'
  op 'jsr'
  op 'jmp'
  op 'even'
  op 'quad'
  op 'align'
  op 'dc'
  op 'ds'
  op 'dcb'
  op 'equ'
  op 'set'
  op 'reg'
  op 'bra'
  op 'bt'
  op 'bsr'
  op 'bhi'
  op 'bls'
  op 'bcc'
  op 'bhs'
  op 'bcs'
  op 'blo'
  op 'bne'
  op 'bnz'
  op 'beq'
  op 'bze'
  op 'bvc'
  op 'bvs'
  op 'bpl'
  op 'bmi'
  op 'bge'
  op 'blt'
  op 'bgt'
  op 'ble'
  op 'bnls'
  op 'bnhi'
  op 'bncs'
  op 'bnlo'
  op 'bncc'
  op 'bnhs'
  op 'bneq'
  op 'bnze'
  op 'bnne'
  op 'bnnz'
  op 'bnvs'
  op 'bnvc'
  op 'bnmi'
  op 'bnpl'
  op 'bnlt'
  op 'bnge'
  op 'bnle'
  op 'bngt'
  op 'rts'
  op 'dbra'
  op 'clr'
  op 'neg'
  op 'not'
  op 'tst'
  op 'cmp'
  op 'cmpi'
  op 'cmpa'
  op 'cmpm'
  op 'sub'
  op 'subq'
  op 'subi'
  op 'suba'
  op 'add'
  op 'addq'
  op 'addi'
  op 'adda'
  op 'or'
  op 'ori'
  op 'and'
  op 'andi'
  op 'eor'
  op 'eori'
  op 'link'
  op 'unlk'
  op 'exg'
  op 'ext'
  op 'extb'
  op 'swap'
  op 'asr'
  op 'asl'
  op 'lsr'
  op 'lsl'
  op 'roxr'
  op 'roxl'
  op 'ror'
  op 'rol'
  op 'bchg'
  op 'bclr'
  op 'bset'
  op 'btst'
  op 'st'
  op 'sf'
  op 'shi'
  op 'sls'
  op 'scc'
  op 'shs'
  op 'scs'
  op 'slo'
  op 'sne'
  op 'snz'
  op 'seq'
  op 'sze'
  op 'svc'
  op 'svs'
  op 'spl'
  op 'smi'
  op 'sge'
  op 'slt'
  op 'sgt'
  op 'sle'
  op 'snf'
  op 'snt'
  op 'snls'
  op 'snhi'
  op 'sncs'
  op 'snlo'
  op 'sncc'
  op 'snhs'
  op 'sneq'
  op 'snze'
  op 'snne'
  op 'snnz'
  op 'snvs'
  op 'snvc'
  op 'snmi'
  op 'snpl'
  op 'snlt'
  op 'snge'
  op 'snle'
  op 'sngt'
  op 'divu'
  op 'divs'
  op 'mulu'
  op 'muls'
  op 'divul'
  op 'divsl'
  op 'dbt'
  op 'dbf'
  op 'dbhi'
  op 'dbls'
  op 'dbcc'
  op 'dbhs'
  op 'dbcs'
  op 'dblo'
  op 'dbne'
  op 'dbnz'
  op 'dbeq'
  op 'dbze'
  op 'dbvc'
  op 'dbvs'
  op 'dbpl'
  op 'dbmi'
  op 'dbge'
  op 'dblt'
  op 'dbgt'
  op 'dble'
  op 'dbnf'
  op 'dbnt'
  op 'dbnls'
  op 'dbnhi'
  op 'dbncs'
  op 'dbnlo'
  op 'dbncc'
  op 'dbnhs'
  op 'dbneq'
  op 'dbnze'
  op 'dbnne'
  op 'dbnnz'
  op 'dbnvs'
  op 'dbnvc'
  op 'dbnmi'
  op 'dbnpl'
  op 'dbnlt'
  op 'dbnge'
  op 'dbnle'
  op 'dbngt'
  op 'subx'
  op 'addx'
  op 'negx'
  op 'sbcd'
  op 'abcd'
  op 'nbcd'
  op 'bftst'
  op 'bfextu'
  op 'bfchg'
  op 'bfexts'
  op 'bfclr'
  op 'bfffo'
  op 'bfset'
  op 'bfins'
  op 'trap'
  op 'illegal'
  op 'reset'
  op 'nop'
  op 'rte'
  op 'trapv'
  op 'rtr'
  op 'stop'
  op 'lpstop'
  op 'mac'
  op 'macl'
  op 'msac'
  op 'msacl'
  op 'halt'
  op 'pulse'
  op 'wddata'
  op 'wdebug'
  op 'mov3q'
  op 'mvs'
  op 'mvz'
  op 'sats'
  op 'rtd'
  op 'chk'
  op 'tas'
  op 'movep'
  op 'moves'
  op 'movec'
  op 'bkpt'
  op 'cas'
  op 'cas2'
  op 'cmp2'
  op 'chk2'
  op 'pack'
  op 'unpk'
  op 'trapt'
  op 'trapf'
  op 'traphi'
  op 'trapls'
  op 'trapcc'
  op 'traphs'
  op 'trapcs'
  op 'traplo'
  op 'trapne'
  op 'trapnz'
  op 'trapeq'
  op 'trapze'
  op 'trapvc'
  op 'trapvs'
  op 'trappl'
  op 'trapmi'
  op 'trapge'
  op 'traplt'
  op 'trapgt'
  op 'traple'
  op 'trapnf'
  op 'trapnt'
  op 'trapnls'
  op 'trapnhi'
  op 'trapncs'
  op 'trapnlo'
  op 'trapncc'
  op 'trapnhs'
  op 'trapneq'
  op 'trapnze'
  op 'trapnne'
  op 'trapnnz'
  op 'trapnvs'
  op 'trapnvc'
  op 'trapnmi'
  op 'trapnpl'
  op 'trapnlt'
  op 'trapnge'
  op 'trapnle'
  op 'trapngt'
  op 'tpt'
  op 'tpf'
  op 'tphi'
  op 'tpls'
  op 'tpcc'
  op 'tphs'
  op 'tpcs'
  op 'tplo'
  op 'tpne'
  op 'tpnz'
  op 'tpeq'
  op 'tpze'
  op 'tpvc'
  op 'tpvs'
  op 'tppl'
  op 'tpmi'
  op 'tpge'
  op 'tplt'
  op 'tpgt'
  op 'tple'
  op 'tpnf'
  op 'tpnt'
  op 'tpnls'
  op 'tpnhi'
  op 'tpncs'
  op 'tpnlo'
  op 'tpncc'
  op 'tpnhs'
  op 'tpneq'
  op 'tpnze'
  op 'tpnne'
  op 'tpnnz'
  op 'tpnvs'
  op 'tpnvc'
  op 'tpnmi'
  op 'tpnpl'
  op 'tpnlt'
  op 'tpnge'
  op 'tpnle'
  op 'tpngt'
  op 'callm'
  op 'rtm'
  op 'move16'
  op 'dec'
  op 'inc'
  op 'jbra'
  op 'jbt'
  op 'jbsr'
  op 'jbhi'
  op 'jbls'
  op 'jbcc'
  op 'jbhs'
  op 'jbcs'
  op 'jblo'
  op 'jbne'
  op 'jbnz'
  op 'jbeq'
  op 'jbze'
  op 'jbvc'
  op 'jbvs'
  op 'jbpl'
  op 'jbmi'
  op 'jbge'
  op 'jblt'
  op 'jbgt'
  op 'jble'
  op 'jbnls'
  op 'jbnhi'
  op 'jbncs'
  op 'jbnlo'
  op 'jbncc'
  op 'jbnhs'
  op 'jbneq'
  op 'jbnze'
  op 'jbnne'
  op 'jbnnz'
  op 'jbnvs'
  op 'jbnvc'
  op 'jbnmi'
  op 'jbnpl'
  op 'jbnlt'
  op 'jbnge'
  op 'jbnle'
  op 'jbngt'
  op 'rept'
  op 'irp'
  op 'irpc'
  op 'xdef'
  op 'xref'
  op 'globl'
  op 'entry'
  op 'public'
  op 'extrn'
  op 'external'
  op 'global'
  op 'text'
  op 'data'
  op 'bss'
  op 'comm'
  op 'stack'
  op 'offset'
  op 'offsym'
  op 'macro'
  op 'exitm'
  op 'endm'
  op 'local'
  op 'sizem'
  op 'if'
  op 'ifne'
  op 'iff'
  op 'ifeq'
  op 'ifdef'
  op 'ifndef'
  op 'else'
  op 'elseif'
  op 'elif'
  op 'endif'
  op 'endc'
  op 'end'
  op 'insert'
  op 'include'
  op 'request'
  op 'list'
  op 'nlist'
  op 'lall'
  op 'sall'
  op 'width'
  op 'page'
  op 'title'
  op 'subttl'
  op 'comment'
  op 'fail'
  op 'cpu'
  op 'org'
  op 'file'
  op 'ln'
  op 'def'
  op 'endef'
  op 'val'
  op 'scl'
  op 'type'
  op 'tag'
  op 'line'
  op 'size'
  op 'dim'
  op 'rdata'
  op 'rbss'
  op 'rstack'
  op 'rcomm'
  op 'rldata'
  op 'rlbss'
  op 'rlstack'
  op 'rlcomm'
  op '68000'
  op '68010'
  op '68020'
  op '68030'
  op '68040'
  op '68060'
  op '5200'
  op '5300'
  op '5400'
  op 'fpid'
  op 'pragma'
  op 'fequ'
  op 'fset'
  op 'fmove'
  op 'fint'
  op 'fsinh'
  op 'fintrz'
  op 'fsqrt'
  op 'flognp1'
  op 'fetoxm1'
  op 'ftanh'
  op 'fatan'
  op 'fasin'
  op 'fatanh'
  op 'fsin'
  op 'ftan'
  op 'fetox'
  op 'ftwotox'
  op 'ftentox'
  op 'flogn'
  op 'flog10'
  op 'flog2'
  op 'fabs'
  op 'fcosh'
  op 'fneg'
  op 'facos'
  op 'fcos'
  op 'fgetexp'
  op 'fgetman'
  op 'ftst'
  op 'fcmp'
  op 'fdiv'
  op 'fmod'
  op 'fadd'
  op 'fmul'
  op 'fsgldiv'
  op 'frem'
  op 'fscale'
  op 'fsglmul'
  op 'fsub'
  op 'fssqrt'
  op 'fdsqrt'
  op 'fsabs'
  op 'fdabs'
  op 'fsneg'
  op 'fdneg'
  op 'fsmove'
  op 'fdmove'
  op 'fsdiv'
  op 'fddiv'
  op 'fsadd'
  op 'fdadd'
  op 'fsmul'
  op 'fdmul'
  op 'fssub'
  op 'fdsub'
  op 'fsincos'
  op 'fmovecr'
  op 'fmovem'
  op 'fnop'
  op 'fsave'
  op 'frestore'
  op 'fbf'
  op 'fbeq'
  op 'fbogt'
  op 'fboge'
  op 'fbolt'
  op 'fbole'
  op 'fbogl'
  op 'fbor'
  op 'fbun'
  op 'fbueq'
  op 'fbugt'
  op 'fbuge'
  op 'fbult'
  op 'fbule'
  op 'fbne'
  op 'fbt'
  op 'fbra'
  op 'fbsf'
  op 'fbseq'
  op 'fbgt'
  op 'fbge'
  op 'fblt'
  op 'fble'
  op 'fbgl'
  op 'fbgle'
  op 'fbngle'
  op 'fbngl'
  op 'fbnle'
  op 'fbnlt'
  op 'fbnge'
  op 'fbngt'
  op 'fbsne'
  op 'fbst'
  op 'fdbf'
  op 'fdbra'
  op 'fdbeq'
  op 'fdbogt'
  op 'fdboge'
  op 'fdbolt'
  op 'fdbole'
  op 'fdbogl'
  op 'fdbor'
  op 'fdbun'
  op 'fdbueq'
  op 'fdbugt'
  op 'fdbuge'
  op 'fdbult'
  op 'fdbule'
  op 'fdbne'
  op 'fdbt'
  op 'fdbsf'
  op 'fdbseq'
  op 'fdbgt'
  op 'fdbge'
  op 'fdblt'
  op 'fdble'
  op 'fdbgl'
  op 'fdbgle'
  op 'fdbngle'
  op 'fdbngl'
  op 'fdbnle'
  op 'fdbnlt'
  op 'fdbnge'
  op 'fdbngt'
  op 'fdbsne'
  op 'fdbst'
  op 'fsf'
  op 'fseq'
  op 'fsogt'
  op 'fsoge'
  op 'fsolt'
  op 'fsole'
  op 'fsogl'
  op 'fsor'
  op 'fsun'
  op 'fsueq'
  op 'fsugt'
  op 'fsuge'
  op 'fsult'
  op 'fsule'
  op 'fsne'
  op 'fst'
  op 'fssf'
  op 'fsseq'
  op 'fsgt'
  op 'fsge'
  op 'fslt'
  op 'fsle'
  op 'fsgl'
  op 'fsgle'
  op 'fsngle'
  op 'fsngl'
  op 'fsnle'
  op 'fsnlt'
  op 'fsnge'
  op 'fsngt'
  op 'fssne'
  op 'fsst'
  op 'ftrapf'
  op 'ftrapeq'
  op 'ftrapogt'
  op 'ftrapoge'
  op 'ftrapolt'
  op 'ftrapole'
  op 'ftrapogl'
  op 'ftrapor'
  op 'ftrapun'
  op 'ftrapueq'
  op 'ftrapugt'
  op 'ftrapuge'
  op 'ftrapult'
  op 'ftrapule'
  op 'ftrapne'
  op 'ftrapt'
  op 'ftrapsf'
  op 'ftrapseq'
  op 'ftrapgt'
  op 'ftrapge'
  op 'ftraplt'
  op 'ftraple'
  op 'ftrapgl'
  op 'ftrapgle'
  op 'ftrapngle'
  op 'ftrapngl'
  op 'ftrapnle'
  op 'ftrapnlt'
  op 'ftrapnge'
  op 'ftrapngt'
  op 'ftrapsne'
  op 'ftrapst'
  op 'cinvl'
  op 'cinvp'
  op 'cinva'
  op 'cpushl'
  op 'cpushp'
  op 'cpusha'
  op 'pflusha'
  op 'pflush'
  op 'pflushan'
  op 'pflushn'
  op 'pflushs'
  op 'pflushr'
  op 'pmove'
  op 'pmovefd'
  op 'ploadr'
  op 'ploadw'
  op 'ptestw'
  op 'ptestr'
  op 'plpaw'
  op 'plpar'
  op 'psave'
  op 'prestore'
  op 'pvalid'
  op 'pbbs'
  op 'pbbc'
  op 'pbls'
  op 'pblc'
  op 'pbss'
  op 'pbsc'
  op 'pbas'
  op 'pbac'
  op 'pbws'
  op 'pbwc'
  op 'pbis'
  op 'pbic'
  op 'pbgs'
  op 'pbgc'
  op 'pbcs'
  op 'pbcc'
  op 'pdbbs'
  op 'pdbbc'
  op 'pdbls'
  op 'pdblc'
  op 'pdbss'
  op 'pdbsc'
  op 'pdbas'
  op 'pdbac'
  op 'pdbws'
  op 'pdbwc'
  op 'pdbis'
  op 'pdbic'
  op 'pdbgs'
  op 'pdbgc'
  op 'pdbcs'
  op 'pdbcc'
  op 'psbs'
  op 'psbc'
  op 'psls'
  op 'pslc'
  op 'psss'
  op 'pssc'
  op 'psas'
  op 'psac'
  op 'psws'
  op 'pswc'
  op 'psis'
  op 'psic'
  op 'psgs'
  op 'psgc'
  op 'pscs'
  op 'pscc'
  op 'ptrapbs'
  op 'ptrapbc'
  op 'ptrapls'
  op 'ptraplc'
  op 'ptrapss'
  op 'ptrapsc'
  op 'ptrapas'
  op 'ptrapac'
  op 'ptrapws'
  op 'ptrapwc'
  op 'ptrapis'
  op 'ptrapic'
  op 'ptrapgs'
  op 'ptrapgc'
  op 'ptrapcs'
  op 'ptrapcc'
  .dc.b 0

BUFFER_SIZE: .equ 16*1024
.fail BUFFER_SIZE<(len+1024)


.bss

.even
Buffer: .ds.b BUFFER_SIZE


.end ProgramStart
